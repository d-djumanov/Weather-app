<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather & Air Quality App</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #e3eaf2;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    main {
      background: #fff;
      margin-top: 40px;
      padding: 2rem 2.5rem 2rem 2.5rem;
      border-radius: 18px;
      box-shadow: 0 2px 16px #b6c8d8a0;
      min-width: 340px;
      max-width: 90vw;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin: 0 0 1.2rem 0;
      text-align: center;
      color: #3a475e;
      letter-spacing: 0.08em;
    }
    #search-form {
      display: flex;
      gap: 0.6rem;
      margin-bottom: 1.2rem;
      width: 100%;
      max-width: 350px;
      justify-content: center;
    }
    #city-input {
      flex: 1;
      padding: 0.5rem 0.7rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #b6c8d8;
      outline: none;
      transition: border-color 0.2s;
    }
    #city-input:focus {
      border-color: #3a475e;
    }
    #search-form button {
      padding: 0.5rem 1.1rem;
      font-size: 1rem;
      background: #3a475e;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #search-form button:hover {
      background: #60759e;
    }
    #error-message {
      color: #d32f2f;
      font-size: 1rem;
      margin-bottom: 0.7rem;
      min-height: 1.2em;
      text-align: center;
    }
    #location-name {
      font-size: 2.3rem;
      font-weight: bold;
      color: #2e3b55;
      letter-spacing: 0.04em;
      margin-bottom: 1.2rem;
      display: none;
      text-align: center;
      line-height: 1.1;
      text-shadow: 0 2px 12px #b6c8d820;
    }
    #weather-section, #aqi-section {
      width: 100%;
      margin-top: 1.3rem;
      display: none;
      flex-direction: column;
      align-items: center;
      transition: opacity 0.3s;
      opacity: 1;
    }
    #weather-section.visible, #aqi-section.visible {
      display: flex;
      opacity: 1;
    }
    .weather-main {
      display: flex;
      align-items: center;
      gap: 1.1rem;
    }
    #weather-icon {
      width: 64px;
      height: 64px;
      object-fit: contain;
    }
    .weather-details {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      align-items: flex-start;
    }
    #temperature {
      font-size: 2.1rem;
      font-weight: bold;
      color: #3a475e;
    }
    #toggle-temp {
      margin-left: 0.7rem;
      font-size: 1.1rem;
      background: #e3eaf2;
      border: 1px solid #b6c8d8;
      border-radius: 3px;
      padding: 0.07em 0.45em;
      cursor: pointer;
      color: #3a475e;
      transition: background 0.1s;
    }
    #toggle-temp:hover {
      background: #c2d4ee;
    }
    #weather-desc {
      color: #60759e;
      font-size: 1.1rem;
      letter-spacing: 0.04em;
      text-transform: capitalize;
    }
    #weather-extra {
      margin-top: 0.7rem;
      color: #60759e;
      font-size: 1rem;
      display: flex;
      gap: 1.1rem;
    }
    /* AQI Styles */
    #aqi-section .aqi-label {
      font-size: 1.08rem;
      color: #3a475e;
    }
    #aqi-value {
      font-size: 1.3rem;
      font-weight: bold;
      margin-top: 0.2rem;
      color: #388e3c;
    }
    #aqi-desc {
      font-size: 1rem;
      color: #60759e;
      margin-top: 0.2rem;
    }
    /* Responsive */
    @media (max-width: 500px) {
      main {
        padding: 1rem 0.5rem;
        min-width: 0;
        width: 98vw;
      }
      #weather-section, #aqi-section {
        margin-top: 0.8rem;
      }
      .weather-main {
        flex-direction: column;
        gap: 0.3rem;
      }
      #weather-icon {
        width: 44px;
        height: 44px;
      }
      #temperature {
        font-size: 1.4rem;
      }
      #weather-desc {
        font-size: 0.95rem;
      }
      #aqi-value {
        font-size: 1.1rem;
      }
      #location-name {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body>
  <main>
    <h1>Weather & Air Quality</h1>
    <form id="search-form" autocomplete="off">
      <input type="text" id="city-input" placeholder="Enter city" required>
      <button type="submit">Search</button>
    </form>
    <div id="location-name"></div>
    <div id="error-message"></div>
    <section id="weather-section">
      <div class="weather-main">
        <img id="weather-icon" src="" alt="Weather Icon" />
        <div class="weather-details">
          <span id="temperature">--°C</span>
          <button id="toggle-temp" type="button">Show °F</button>
          <span id="weather-desc"></span>
        </div>
      </div>
      <div id="weather-extra">
        <span id="humidity"></span>
        <span id="wind"></span>
      </div>
    </section>
    <section id="aqi-section">
      <div class="aqi-label">Air Quality Index</div>
      <div id="aqi-value">--</div>
      <div id="aqi-desc"></div>
    </section>
  </main>
  <script>
    // ======= INSERT YOUR OPENWEATHERMAP API KEY HERE =======
    const API_KEY = "0712d2e7e8798c7700e97fc00197f8a9"; // <-- Replace with your OpenWeatherMap API key
    // =======================================================

    const form = document.getElementById('search-form');
    const cityInput = document.getElementById('city-input');
    const weatherSection = document.getElementById('weather-section');
    const aqiSection = document.getElementById('aqi-section');
    const errorMessage = document.getElementById('error-message');
    const tempToggleBtn = document.getElementById('toggle-temp');
    const locationNameDiv = document.getElementById('location-name');

    let currentTempC = null;
    let currentTempF = null;
    let isCelsius = true;

    function setBackgroundByWeather(main) {
      let bg = "";
      switch (main) {
        case "Clear":
          bg = "linear-gradient(135deg, #f6d365 0%, #fda085 100%)";
          break;
        case "Clouds":
          bg = "linear-gradient(135deg, #c2e9fb 0%, #81a4fd 100%)";
          break;
        case "Rain":
        case "Drizzle":
          bg = "linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)";
          break;
        case "Thunderstorm":
          bg = "linear-gradient(135deg, #667db6 0%, #0082c8 100%)";
          break;
        case "Snow":
          bg = "linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%)";
          break;
        default:
          bg = "linear-gradient(135deg, #e3eaf2 0%, #b6c8d8 100%)";
      }
      document.body.style.background = bg;
    }

    function showWeather(data) {
      if (!data) return;
      document.getElementById('weather-icon').src =
        `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
      document.getElementById('weather-desc').textContent =
        data.weather[0].description;
      currentTempC = Math.round(data.main.temp);
      currentTempF = Math.round(currentTempC * 9 / 5 + 32);
      document.getElementById('temperature').textContent =
        isCelsius ? `${currentTempC}°C` : `${currentTempF}°F`;
      document.getElementById('humidity').textContent =
        `Humidity: ${data.main.humidity}%`;
      document.getElementById('wind').textContent =
        `Wind: ${data.wind.speed} m/s`;
      weatherSection.classList.add('visible');
      setBackgroundByWeather(data.weather[0].main);
    }

    function showAQI(aqi) {
      if (!aqi) return;
      document.getElementById('aqi-value').textContent = aqi.aqi;
      const levels = [
        'Good', 'Fair', 'Moderate', 'Poor', 'Very Poor'
      ];
      const colors = [
        '#388e3c', '#fbc02d', '#f57c00', '#d32f2f', '#8e24aa'
      ];
      document.getElementById('aqi-desc').textContent =
        levels[aqi.aqi - 1] || '';
      document.getElementById('aqi-value').style.color =
        colors[aqi.aqi - 1] || '#333';
      aqiSection.classList.add('visible');
    }

    function hideResults() {
      weatherSection.classList.remove('visible');
      aqiSection.classList.remove('visible');
      document.body.style.background = "#e3eaf2";
    }

    function showError(msg) {
      errorMessage.textContent = msg;
      hideResults();
    }

    function clearError() {
      errorMessage.textContent = "";
    }

    function setLocationName(name) {
      if (name && name.length > 0) {
        locationNameDiv.textContent = name;
        locationNameDiv.style.display = "block";
      } else {
        locationNameDiv.textContent = "";
        locationNameDiv.style.display = "none";
      }
    }

    // SEARCH FORM HANDLING
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideResults();
      clearError();
      setLocationName(""); // Hide location name if searching manually
      const city = cityInput.value.trim();
      if (!city) return;
      try {
        const weatherRes = await fetch(
          `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${API_KEY}&units=metric`
        );
        if (!weatherRes.ok) throw new Error("City not found");
        const weatherData = await weatherRes.json();
        showWeather(weatherData);

        // AQI fetch
        const { lon, lat } = weatherData.coord;
        const aqiRes = await fetch(
          `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${API_KEY}`
        );
        if (aqiRes.ok) {
          const aqiData = await aqiRes.json();
          if (aqiData.list && aqiData.list[0]) {
            showAQI(aqiData.list[0].main);
          }
        }
      } catch (err) {
        showError(err.message || "Failed to get weather.");
      }
    });

    tempToggleBtn.addEventListener('click', () => {
      if (currentTempC === null || currentTempF === null) return;
      isCelsius = !isCelsius;
      document.getElementById('temperature').textContent =
        isCelsius ? `${currentTempC}°C` : `${currentTempF}°F`;
      tempToggleBtn.textContent = isCelsius ? "Show °F" : "Show °C";
    });

    // ====== AUTO-LOCATE AND WEATHER ON PAGE LOAD ======
    async function reverseGeocode(lat, lon) {
      try {
        // Use OpenWeatherMap reverse geocoding (limited), or you could use Nominatim or Google Geocoding API if desired
        const res = await fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${API_KEY}`);
        if (res.ok) {
          const data = await res.json();
          if (data && data[0]) {
            // Prefer city, else fall back to name/country
            let city = data[0].name || data[0].local_names?.en || "";
            let country = data[0].country || "";
            let state = data[0].state || "";
            let locText = city;
            if (state && state !== city) locText += ", " + state;
            if (country) locText += (locText ? ", " : "") + country;
            return locText;
          }
        }
      } catch (e) {}
      return "";
    }

    async function getWeatherByLocation(lat, lon) {
      hideResults();
      clearError();
      try {
        const weatherRes = await fetch(
          `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`
        );
        if (!weatherRes.ok) throw new Error("Location weather not found");
        const weatherData = await weatherRes.json();
        showWeather(weatherData);

        // Fetch AQI by lat/lon
        const aqiRes = await fetch(
          `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${API_KEY}`
        );
        if (aqiRes.ok) {
          const aqiData = await aqiRes.json();
          if (aqiData.list && aqiData.list[0]) {
            showAQI(aqiData.list[0].main);
          }
        }

        // Get city/location name and show it
        const locName = await reverseGeocode(lat, lon);
        setLocationName(locName);

        // Always hide search form if we have location (even if reverse geocode fails)
        form.style.display = "none";
      } catch (err) {
        showError("Unable to get weather for your location.");
        setLocationName("");
        form.style.display = "flex";
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            getWeatherByLocation(lat, lon);
          },
          (error) => {
            // User denied or error – show search form, hide location name
            setLocationName("");
            form.style.display = "flex";
          }
        );
      } else {
        // Geolocation not available – show search form
        setLocationName("");
        form.style.display = "flex";
      }
    });
  </script>
</body>
</html>
